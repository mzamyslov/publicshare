<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, width=device-width" />
  <title>Norway Fylke/Kommuner + Barnehager</title>
  <style>
    html,body,#map{height:100%;margin:0}
    .legend{position:absolute;bottom:12px;left:12px;background:#fff;padding:8px 10px;border:1px solid #ccc;border-radius:8px;font:12px system-ui}
    .ctl{position:absolute;top:12px;left:12px;background:#fff;padding:6px 8px;border:1px solid #ccc;border-radius:8px;font:12px system-ui}
  </style>
  <script src="metrics.js"></script>
<script defer type="module">
  // ===================== CONFIG =====================
  const CFG = {
    urls: {
      fylke: "./fylke.geojson",
      kommune: "./kommune.geojson",
      barnehager: "./barnehager.json",
    },
    zoom: {
      initial: 5.2,
      showKommunerFrom: 9, // с какого зума показывать kommuner вместо fylke
    },
    opacity: {
      // ВАЖНО: maxOpacity применяется на малом зуме, minOpacity — на большом (уменьшаем opacity при приближении)
      fylke:   { minZoom: 1,  maxZoom: 9,  maxOpacity: 0.95, minOpacity: 0.55 },
      kommune: { minZoom: 9,  maxZoom: 13, maxOpacity: 0.55, minOpacity: 0.0 },
    },
    poly: {
      fylkeStroke: 0.3,
      kommuneStroke: 0.3,
    },
    points: {
      radiusM: 40,
      strokeWeight: 4,
    },
    mapStyle: [
      { elementType: "geometry", stylers: [{ color: "#5a5a5a" }] },
      { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#f0f0f0" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#5a5a5a" }] },
      { featureType: "poi", elementType: "geometry", stylers: [{ color: "#4f4f4f" }] },
      { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#494949" }] },
      { featureType: "road", elementType: "geometry", stylers: [{ color: "#bfbfbf" }] },
      { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#a6a6a6" }] },
      { featureType: "road.local", elementType: "geometry", stylers: [{ color: "#b0b0b0" }] },
      { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
      { featureType: "transit.line", elementType: "geometry", stylers: [{ color: "#9c9c9c" }] },
      { featureType: "transit.station", elementType: "geometry", stylers: [{ color: "#a8a8a8" }] },
      { featureType: "water", elementType: "geometry", stylers: [{ color: "#d6d6d6" }] }, // светлее суши
      { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#666666" }] }
    ],
  };
  
  // ===================== COLOR SCALES =====================
  function colorScale(v, min=0.0, max=10.0){
    if (v == null || isNaN(v)) return "#e0e0e0";
    const clamped = Math.max(min, Math.min(max, v));
    const t = (clamped - min) / (max - min);
    const hue = 0 + t * 120; // 0=red → 120=green
    return `hsl(${hue}, 100%, 50%)`;
  }
  
  function pointColor(v, min=0.0, max=10.0){
    if (v == null || isNaN(v)) return "#888";
    const clamped = Math.max(min, Math.min(max, v));
    const t = (clamped - min) / (max - min);
    const hue = 0 + t * 120;
    return `hsl(${hue}, 100%, 50%)`;
  }
  
  // ===================== HELPERS =====================
  function clamp01(x){ return Math.min(1, Math.max(0, x)); }
  
  //Transparency decreases with zoom:
  // when minZoom → maxOpacity, when maxZoom → minOpacity
  function opacityForZoomDown(zoom, cfg){
    const t = clamp01((zoom - cfg.minZoom) / (cfg.maxZoom - cfg.minZoom));
    return cfg.maxOpacity - t * (cfg.maxOpacity - cfg.minOpacity);
  }
  
  // ===================== MAP + LAYERS =====================
  let map, fylkeLayer, kommuneLayer, markers = [];
  
  async function initMap(){
    const { Map } = await google.maps.importLibrary("maps");
  
    map = new Map(document.getElementById("map"), {
      center: {lat: 64.5, lng: 11.0},
      zoom: CFG.zoom.initial,
      styles: CFG.mapStyle
    });
  
    // Layers
    const styleFylke = f => {
      const id = f.getProperty("fylkesnummer") || f.getProperty("fylke_nr");
      const v = (typeof metricsFylke !== "undefined") ? metricsFylke[id] : undefined;
      const c = colorScale(v, 4.38, 4.6);      
      return {
        fillColor: c,
        fillOpacity: opacityForZoomDown(map.getZoom(), CFG.opacity.fylke),
        strokeColor: c,
        strokeWeight: CFG.poly.fylkeStroke,
        zIndex: 1
      };
    };
  
    const styleKommune = f => {
      const id = f.getProperty("kommunenummer") || f.getProperty("komm_nr");
      const v = (typeof metricsKommune !== "undefined") ? metricsKommune[id] : undefined;
      const c = colorScale(v, 3.3, 4.9);
      return {
        fillColor: c,
        fillOpacity: opacityForZoomDown(map.getZoom(), CFG.opacity.kommune),
        strokeColor: c,
        strokeWeight: CFG.poly.kommuneStroke,
        zIndex: 2
      };
    };
  
    fylkeLayer   = await addChoroplethLayer(CFG.urls.fylke,   styleFylke);
    kommuneLayer = await addChoroplethLayer(CFG.urls.kommune, styleKommune);
    kommuneLayer.setMap(null); // Hidden by default
  
    // Switching layers + refreshing styles on zoom
    map.addListener("zoom_changed", ()=>{
      const z = map.getZoom();
      if (z >= CFG.zoom.showKommunerFrom){
        fylkeLayer.setMap(null);
        kommuneLayer.setMap(map);
      } else {
        kommuneLayer.setMap(null);
        fylkeLayer.setMap(map);
      }
      // re-request styles (Data will apply styleFn again)
      fylkeLayer.setStyle(styleFylke);
      kommuneLayer.setStyle(styleKommune);
    });
  
    // Points Barnehager as circles
    await addBarnehager();
  
    // Legend can be uncommunted if needed
    // buildLegend();
  }
  
  async function addChoroplethLayer(url, styleFn){
    const layer = new google.maps.Data({ map });
    const resp = await fetch(url, {cache:"no-store"});
    const gj = await resp.json();
    layer.addGeoJson(gj, { idPropertyName: "id" });
    layer.setStyle(styleFn);
  
    layer.addListener("mouseover", e => {
      layer.overrideStyle(e.feature, { strokeWeight: 2 });
      map.getDiv().style.cursor = "pointer";
    });
    layer.addListener("mouseout", e => {
      layer.revertStyle(e.feature);
      map.getDiv().style.cursor = "default";
    });
    layer.addListener("click", e => {
      const name = e.feature.getProperty("navn") || e.feature.getProperty("name");
      const val =
        (typeof metricsFylke !== "undefined" ? metricsFylke[e.feature.getProperty("fylkesnummer")] : undefined) ??
        (typeof metricsKommune !== "undefined" ? metricsKommune[e.feature.getProperty("kommunenummer")] : undefined);
      new google.maps.InfoWindow({
        content: `<b>${name ?? "Region"}</b><br/>Значение: ${val ?? "—"}`
      }).open({ map, position: e.latLng });
    });
  
    return layer;
  }
  
  async function addBarnehager(){
    const resp = await fetch(CFG.urls.barnehager, {cache:"no-store"});
    const items = await resp.json(); // [{lat,lng,name,value},...]
  
    for (const it of items){
      const circle = new google.maps.Circle({
        map,
        center: {lat: it.lat, lng: it.lng},
        radius: CFG.points.radiusM,               // in meters
        strokeWeight: CFG.points.strokeWeight,
        strokeColor: pointColor(it.value, 3, 5),  // gradient from red to green
        fillColor:   pointColor(it.value, 3, 5),
        fillOpacity: 0.9,
        zIndex: 1000
      });
      circle.addListener("click", ()=>{
        new google.maps.InfoWindow({
          content: `<b>${it.name ?? "Barnehage"}</b><br/>Показатель: ${it.value ?? "—"}`
        }).open({ map, position: {lat: it.lat, lng: it.lng} });
      });
      markers.push(circle);
    }
  }
  
  window.initMap = initMap;
</script>
</head>
<body>
  <div id="map"></div>
  <!--<div class="ctl">Wheel: Zoom · Click: Info</div>
  <div class="legend" id="legend">Legend</div>-->
  <script>
    /*function buildLegend(){
      const lg = document.getElementById("legend");
      const bins = [[0,5],[5,10],[10,15],[15,20],[20,Infinity]];
      for (const [a,b] of bins){
        const v = a===0 ? 4.9 : a+0.1;
        const c = (b===Infinity) ? colorScale(25) : colorScale(v);
        const label = (b===Infinity) ? `${a}+` : `${a}–${b}`;
        const row = document.createElement("div");
        row.innerHTML = `<span style="display:inline-block;width:12px;height:12px;background:${c};border:1px solid #aaa;margin-right:6px;"></span>${label}`;
        lg.appendChild(row);
      }
    }*/
  </script>
  
  <script defer src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.umd.js"></script>
  
  <script defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBAkTsDSCyrZ6zOdMuynDewilR2WpJFyKc&libraries=maps,marker&callback=initMap"></script>


</body>

</html>












































