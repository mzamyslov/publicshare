<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, width=device-width" />
  <title>Norway Fylke/Kommuner + Barnehager</title>
  <style>
    html,body,#map{height:100%;margin:0}
    .bh-label{
      position:relative;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      font-weight:600;
      line-height:1;
      letter-spacing:0.2px;
      color:#111;
      text-align:center;
      transform:translate(-50%,-50%);
      text-shadow:
        -1px -1px 0 #fff,
         0   -1px 0 #fff,
         1px -1px 0 #fff,
        -1px  0   0 #fff,
         1px  0   0 #fff,
        -1px  1px 0 #fff,
         0    1px 0 #fff,
         1px  1px 0 #fff;
      pointer-events:none;
    }
  </style>
  <script src="metrics.js"></script>
  <script defer type="module">

    const CFG = {
      urls: { barnehager: "./barnehager.json" },
      zoom: { initial: 5.2 },
      labels: { showFromZoom: 10, minPx: 10, maxPx: 18 },
      points: { radiusM: 40, strokeWeight: 4 }
    };

    function pointColor(v, min=0, max=10) {
      if (v == null || isNaN(v)) return "#666";
      const t = Math.min(1, Math.max(0, (v - min) / (max - min)));
      const hue = 0 + t * 120;
      return `hsl(${hue}, 100%, 50%)`;
    }

    function clamp01(x) { 
      return Math.min(1, Math.max(0, x)); 
    }

    function fontPxForZoom(z, minPx = CFG.labels.minPx, maxPx = CFG.labels.maxPx) {
      const z0 = CFG.labels.showFromZoom, z1 = 14;
      const t = clamp01((z - z0) / (z1 - z0));
      return Math.round(minPx + t * (maxPx - minPx));
    }

    class BHLabel extends google.maps.OverlayView {
      constructor(position, text, fontPx) {
        super();
        this.position = position;
        this.el = document.createElement("div");
        this.el.className = "bh-label";
        this.setText(text);
        this.setFontPx(fontPx);
      }
      onAdd() {
        this.getPanes().overlayMouseTarget.appendChild(this.el);
      }
      draw() {
        const p = this.getProjection(); 
        if (!p) return;
        const pt = p.fromLatLngToDivPixel(this.position); 
        if (!pt) return;
        this.el.style.position = "absolute";
        this.el.style.left = `${pt.x}px`;
        this.el.style.top = `${pt.y}px`;
      }
      onRemove() {
        if (this.el?.parentNode) this.el.parentNode.removeChild(this.el);
      }
      setText(t) { this.el.textContent = t; }
      setFontPx(px) { this.el.style.fontSize = `${px}px`; }
      setVisible(v) { this.el.style.display = v ? "block" : "none"; }
    }

    let map, markers = [], labels = [];

    async function initMap() {
      const { Map } = await google.maps.importLibrary("maps");
      map = new Map(document.getElementById("map"), {
        center: { lat: 64.5, lng: 11.0 },
        zoom: CFG.zoom.initial
      });

      await addBarnehager();

      map.addListener("zoom_changed", () => {
        const z = map.getZoom();
        const show = z >= CFG.labels.showFromZoom;
        const fs = fontPxForZoom(z);
        for (const o of labels) {
          o.setFontPx(fs);
          o.setVisible(show);
          o.draw();
        }
      });
    }

    async function addBarnehager() {
      const resp = await fetch(CFG.urls.barnehager, { cache: "no-store" });
      const items = await resp.json();
      const z = map.getZoom();
      const show = z >= CFG.labels.showFromZoom;
      const fontPx = fontPxForZoom(z);

      for (const it of items) {
        const circle = new google.maps.Circle({
          map,
          center: { lat: it.lat, lng: it.lng },
          radius: CFG.points.radiusM,
          strokeWeight: CFG.points.strokeWeight,
          strokeColor: pointColor(it.value),
          fillColor: pointColor(it.value),
          fillOpacity: 0.9,
          zIndex: 1000
        });
        markers.push(circle);

        const text = (typeof it.value === "number" && !Number.isNaN(it.value)) 
          ? it.value.toFixed(1) : "â€”";
        const overlay = new BHLabel(new google.maps.LatLng(it.lat, it.lng), text, fontPx);
        overlay.setMap(map);
        overlay.setVisible(show);
        labels.push(overlay);
      }
    }

    window.initMap = initMap;

  </script>
</head>
<body>
  <div id="map"></div>
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBAkTsDSCyrZ6zOdMuynDewilR2WpJFyKc&callback=initMap"></script>
</body>
</html>
