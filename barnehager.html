<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, width=device-width" />
  <title>Norway Fylke/Kommuner + Barnehager</title>
  <style>
    html,body,#map{height:100%;margin:0}
    .legend{position:absolute;bottom:12px;left:12px;background:#fff;padding:8px 10px;border:1px solid #ccc;border-radius:8px;font:12px system-ui}
    .ctl{position:absolute;top:12px;left:12px;background:#fff;padding:6px 8px;border:1px solid #ccc;border-radius:8px;font:12px system-ui}
    .bh-label{
      position:relative;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      font-weight:600;
      line-height:1;
      letter-spacing:0.2px;
      color:#111;
      text-align:center;
      transform:translate(-50%,-50%);
      text-shadow:
        -1px -1px 0 #fff,
         0   -1px 0 #fff,
         1px -1px 0 #fff,
        -1px  0   0 #fff,
         1px  0   0 #fff,
        -1px  1px 0 #fff,
         0    1px 0 #fff,
         1px  1px 0 #fff;
      pointer-events:none;
    }
  </style>
  <script src="metrics.js"></script>
  <script defer type="module">
    const CFG = {
      urls: {
        fylke: "./fylke.geojson",
        kommune: "./kommune.geojson",
        barnehager: "./barnehager.json",
      },
      zoom: { initial: 5.2, showKommunerFrom: 9 },
      opacity: {
        fylke:   { minZoom: 5,  maxZoom: 9,  maxOpacity: 0.35, minOpacity: 0.08 },
        kommune: { minZoom: 7,  maxZoom: 12, maxOpacity: 0.45, minOpacity: 0.12 },
      },
      poly: { fylkeStroke: 0.5, kommuneStroke: 0.25 },
      points: { radiusM: 40, strokeWeight: 1.5 },
      labels: { showFromZoom: 10, minPx: 10, maxPx: 18 },
      mapStyle: [
        { elementType: "geometry", stylers: [{ color: "#5a5a5a" }] },
        { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
        { elementType: "labels.text.fill", stylers: [{ color: "#f0f0f0" }] },
        { elementType: "labels.text.stroke", stylers: [{ color: "#5a5a5a" }] },
        { featureType: "poi", elementType: "geometry", stylers: [{ color: "#4f4f4f" }] },
        { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#494949" }] },
        { featureType: "road", elementType: "geometry", stylers: [{ color: "#bfbfbf" }] },
        { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#a6a6a6" }] },
        { featureType: "road.local", elementType: "geometry", stylers: [{ color: "#b0b0b0" }] },
        { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
        { featureType: "transit.line", elementType: "geometry", stylers: [{ color: "#9c9c9c" }] },
        { featureType: "transit.station", elementType: "geometry", stylers: [{ color: "#a8a8a8" }] },
        { featureType: "water", elementType: "geometry", stylers: [{ color: "#d6d6d6" }] },
        { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#666666" }] }
      ],
    };
    function colorScale(v, min=0, max=20){
      if (v == null || isNaN(v)) return "#e0e0e0";
      const t = Math.min(1, Math.max(0, (v - min) / (max - min)));
      const hue = 0 + t * 120;
      return `hsl(${hue}, 100%, 50%)`;
    }
    function pointColor(v, min=2, max=9){
      if (v == null || isNaN(v)) return "#666";
      const t = Math.min(1, Math.max(0, (v - min) / (max - min)));
      const hue = 0 + t * 120;
      return `hsl(${hue}, 100%, 50%)`;
    }
    function clamp01(x){ return Math.min(1, Math.max(0, x)); }
    function opacityForZoomDown(zoom, cfg){
      const t = clamp01((zoom - cfg.minZoom) / (cfg.maxZoom - cfg.minZoom));
      return cfg.maxOpacity - t * (cfg.maxOpacity - cfg.minOpacity);
    }
    function fontPxForZoom(z, minPx=CFG.labels.minPx, maxPx=CFG.labels.maxPx){
      const z0 = CFG.labels.showFromZoom, z1 = 14;
      const t = clamp01((z - z0) / (z1 - z0));
      return Math.round(minPx + t * (maxPx - minPx));
    }
    class BHLabel extends google.maps.OverlayView {
      constructor(position, text, fontPx) {
        super();
        this.position = position;
        this.el = document.createElement("div");
        this.el.className = "bh-label";
        this.setText(text);
        this.setFontPx(fontPx);
      }
      onAdd() { this.getPanes().overlayMouseTarget.appendChild(this.el); }
      draw() {
        const proj = this.getProjection(); if (!proj) return;
        const pt = proj.fromLatLngToDivPixel(this.position); if (!pt) return;
        this.el.style.position = "absolute";
        this.el.style.left = `${pt.x}px`;
        this.el.style.top  = `${pt.y}px`;
      }
      onRemove() { if (this.el?.parentNode) this.el.parentNode.removeChild(this.el); }
      setText(t){ this.el.textContent = t; }
      setFontPx(px){ this.el.style.fontSize = `${px}px`; }
      setVisible(v){ this.el.style.display = v ? "block" : "none"; }
    }
    let map, fylkeLayer, kommuneLayer, markers = [], labels = [];
    async function initMap(){
      const { Map } = await google.maps.importLibrary("maps");
      map = new Map(document.getElementById("map"), {
        center: {lat: 64.5, lng: 11.0},
        zoom: CFG.zoom.initial,
        styles: CFG.mapStyle
      });
      const styleFylke = f => {
        const id = f.getProperty("fylkesnummer") || f.getProperty("fylke_nr");
        const v  = (typeof metricsFylke !== "undefined") ? metricsFylke[id] : undefined;
        const c  = colorScale(v);
        return { fillColor: c, fillOpacity: opacityForZoomDown(map.getZoom(), CFG.opacity.fylke), strokeColor: c, strokeWeight: CFG.poly.fylkeStroke, zIndex: 1 };
      };
      const styleKommune = f => {
        const id = f.getProperty("kommunenummer") || f.getProperty("komm_nr");
        const v  = (typeof metricsKommune !== "undefined") ? metricsKommune[id] : undefined;
        const c  = colorScale(v);
        return { fillColor: c, fillOpacity: opacityForZoomDown(map.getZoom(), CFG.opacity.kommune), strokeColor: c, strokeWeight: CFG.poly.kommuneStroke, zIndex: 2 };
      };
      fylkeLayer   = await addChoroplethLayer(CFG.urls.fylke,   styleFylke);
      kommuneLayer = await addChoroplethLayer(CFG.urls.kommune, styleKommune);
      kommuneLayer.setMap(null);
      map.addListener("zoom_changed", ()=>{
        const z = map.getZoom();
        if (z >= CFG.zoom.showKommunerFrom){ fylkeLayer.setMap(null); kommuneLayer.setMap(map); }
        else { kommuneLayer.setMap(null); fylkeLayer.setMap(map); }
        fylkeLayer.setStyle(styleFylke); kommuneLayer.setStyle(styleKommune);
        const show = z >= CFG.labels.showFromZoom; const fs = fontPxForZoom(z);
        for (const o of labels){ o.setFontPx(fs); o.setVisible(show); o.draw(); }
      });
      await addBarnehager();
    }
    async function addChoroplethLayer(url, styleFn){
      const layer = new google.maps.Data({ map });
      const resp = await fetch(url, {cache:"no-store"});
      const gj = await resp.json();
      layer.addGeoJson(gj, { idPropertyName: "id" });
      layer.setStyle(styleFn);
      layer.addListener("mouseover", e => { layer.overrideStyle(e.feature, { strokeWeight: 2 }); map.getDiv().style.cursor = "pointer"; });
      layer.addListener("mouseout", e => { layer.revertStyle(e.feature); map.getDiv().style.cursor = "default"; });
      layer.addListener("click", e => {
        const name = e.feature.getProperty("navn") || e.feature.getProperty("name");
        const val = (typeof metricsFylke !== "undefined" ? metricsFylke[e.feature.getProperty("fylkesnummer")] : undefined) ?? (typeof metricsKommune !== "undefined" ? metricsKommune[e.feature.getProperty("kommunenummer")] : undefined);
        new google.maps.InfoWindow({ content: `<b>${name ?? "Region"}</b><br/>Значение: ${val ?? "—"}` }).open({ map, position: e.latLng });
      });
      return layer;
    }
    async function addBarnehager(){
      const resp = await fetch(CFG.urls.barnehager, {cache:"no-store"});
      const items = await resp.json();
      const z = map.getZoom(); const showLabels = z >= CFG.labels.showFromZoom; const fontPx = fontPxForZoom(z);
      for (const it of items){
        const circle = new google.maps.Circle({
          map, center: {lat: it.lat, lng: it.lng}, radius: CFG.points.radiusM,
          strokeWeight: CFG.points.strokeWeight,
          strokeColor: pointColor(it.value, 2, 9),
          fillColor: pointColor(it.value, 2, 9),
          fillOpacity: 0.9, zIndex: 1000
        });
        circle.addListener("click", ()=>{ new google.maps.InfoWindow({ content: `<b>${it.name ?? "Barnehage"}</b><br/>Показатель: ${it.value ?? "—"}` }).open({ map, position: {lat: it.lat, lng: it.lng} }); });
        markers.push(circle);
        const labelText = (typeof it.value === "number" && !Number.isNaN(it.value)) ? it.value.toFixed(1) : "—";
        const overlay = new BHLabel(new google.maps.LatLng(it.lat, it.lng), labelText, fontPx);
        overlay.setMap(map);
        overlay.setVisible(showLabels);
        labels.push(overlay);
      }
    }
    window.initMap = initMap;
  </script>
</head>
<body>
  <div id="map"></div>
  <script defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>
</body>
</html>